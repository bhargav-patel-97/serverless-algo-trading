<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorithmic Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading data...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>üöÄ Algorithmic Trading Dashboard</h1>
            <div class="connection-status" id="connection-status">Connected</div>
        </div>
        <div class="header-right">
            <div class="controls">
                <button id="manual-refresh" class="btn btn-secondary">
                    <span class="icon">üîÑ</span> Refresh
                </button>
                <button id="export-btn" class="btn btn-secondary" onclick="exportData()">
                    <span class="icon">üìä</span> Export
                </button>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-refresh" checked>
                    <span class="slider"></span>
                    <span class="toggle-label">Auto-refresh</span>
                </label>
            </div>
            <div class="last-update">
                Last updated: <span id="last-update">--:--:--</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="navigation">
        <div class="nav-item active" data-tab="overview">üìä Overview</div>
        <div class="nav-item" data-tab="portfolio">üíº Portfolio</div>
        <div class="nav-item" data-tab="trades">üìà Trading</div>
        <div class="nav-item" data-tab="strategies">‚öôÔ∏è Strategies</div>
        <div class="nav-item" data-tab="logs">üìã Logs</div>
        <div class="nav-item" data-tab="backtest">üî¨ Backtest</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Portfolio Summary -->
            <section class="portfolio-summary">
                <div class="summary-card">
                    <div class="metric-label">Total Portfolio Value</div>
                    <div class="metric-value">$0.00</div>
                    <div class="metric-change">+$0.00 (0.00%)</div>
                </div>
                <div class="summary-card">
                    <div class="metric-label">Daily P&L</div>
                    <div class="metric-value">$0.00</div>
                    <div class="metric-change">0.00%</div>
                </div>
                <div class="summary-card">
                    <div class="metric-label">Available Cash</div>
                    <div class="metric-value">$0.00</div>
                    <div class="metric-change">Ready to trade</div>
                </div>
                <div class="summary-card">
                    <div class="metric-label">Active Positions</div>
                    <div class="metric-value">0</div>
                    <div class="metric-change">Across all strategies</div>
                </div>
            </section>

            <!-- Performance Chart -->
            <section class="chart-section">
                <h2>Portfolio Performance</h2>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </section>

            <!-- Recent Activity and ETF Grid -->
            <div class="overview-grid">
                <section class="recent-trades-section">
                    <h2>Recent Trades</h2>
                    <div class="table-container">
                        <table id="recent-trades-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Strategy</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="etf-section">
                    <h2>ETF Monitor</h2>
                    <div class="etf-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </section>
            </div>

            <!-- System Status -->
            <section class="system-status-section">
                <h2>System Status</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <div class="status-label">API Connection</div>
                        <div class="system-status connected">Connected</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Strategies Running</div>
                        <div class="status-value">3</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Errors (24h)</div>
                        <div class="status-value">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Uptime</div>
                        <div class="status-value">99.9%</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolio" class="tab-content">
            <section class="portfolio-details">
                <h2>Portfolio Holdings</h2>
                <div class="table-container">
                    <table id="positions-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Avg Price</th>
                                <th>Current Price</th>
                                <th>Unrealized P&L</th>
                                <th>Market Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Performance Metrics -->
            <section class="performance-metrics">
                <h2>Performance Analysis</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-header">Win Rate</div>
                        <div class="metric-value win-rate">0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">Total Return</div>
                        <div class="metric-value total-return">0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">Sharpe Ratio</div>
                        <div class="metric-value sharpe-ratio">0.00</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">Max Drawdown</div>
                        <div class="metric-value max-drawdown">0%</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Trading Tab -->
        <div id="trades" class="tab-content">
            <!-- Manual Trading Form -->
            <section class="manual-trading">
                <h2>Manual Trading</h2>
                <form id="manual-trade-form" class="trade-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="symbol">Symbol</label>
                            <select id="symbol" name="symbol" required>
                                <option value="">Select Symbol</option>
                                <option value="TQQQ">TQQQ</option>
                                <option value="SQQQ">SQQQ</option>
                                <option value="UPRO">UPRO</option>
                                <option value="SPXU">SPXU</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="side">Side</label>
                            <select id="side" name="side" required>
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" name="quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="orderType">Order Type</label>
                            <select id="orderType" name="orderType">
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="limitPrice">Limit Price (if applicable)</label>
                            <input type="number" id="limitPrice" name="limitPrice" step="0.01">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Execute Trade</button>
                </form>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="action-buttons">
                    <button class="btn btn-warning quick-action-btn" data-action="stop-all">
                        üõë Stop All Positions
                    </button>
                    <button class="btn btn-info quick-action-btn" data-action="pause-trading">
                        ‚è∏Ô∏è Pause Trading
                    </button>
                    <button class="btn btn-success quick-action-btn" data-action="resume-trading">
                        ‚ñ∂Ô∏è Resume Trading
                    </button>
                    <button class="btn btn-danger quick-action-btn" data-action="emergency-exit">
                        üö® Emergency Exit
                    </button>
                </div>
            </section>
        </div>

        <!-- Strategies Tab -->
        <div id="strategies" class="tab-content">
            <section class="strategy-controls">
                <h2>Strategy Management</h2>
                <div class="strategy-grid">
                    <div class="strategy-card">
                        <h3>Momentum Strategy</h3>
                        <p>Moving average crossover signals</p>
                        <label class="toggle-switch">
                            <input type="checkbox" class="strategy-toggle" data-strategy="momentum" checked>
                            <span class="slider"></span>
                            <span class="toggle-label">Enabled</span>
                        </label>
                        <div class="strategy-stats">
                            <div class="stat">
                                <span class="stat-label">Win Rate:</span>
                                <span class="stat-value">65%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Total Trades:</span>
                                <span class="stat-value">42</span>
                            </div>
                        </div>
                    </div>

                    <div class="strategy-card">
                        <h3>Mean Reversion</h3>
                        <p>RSI-based oversold/overbought signals</p>
                        <label class="toggle-switch">
                            <input type="checkbox" class="strategy-toggle" data-strategy="meanReversion" checked>
                            <span class="slider"></span>
                            <span class="toggle-label">Enabled</span>
                        </label>
                        <div class="strategy-stats">
                            <div class="stat">
                                <span class="stat-label">Win Rate:</span>
                                <span class="stat-value">58%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Total Trades:</span>
                                <span class="stat-value">31</span>
                            </div>
                        </div>
                    </div>

                    <div class="strategy-card">
                        <h3>Regime Detection</h3>
                        <p>Bull/bear market identification</p>
                        <label class="toggle-switch">
                            <input type="checkbox" class="strategy-toggle" data-strategy="regimeDetection">
                            <span class="slider"></span>
                            <span class="toggle-label">Disabled</span>
                        </label>
                        <div class="strategy-stats">
                            <div class="stat">
                                <span class="stat-label">Win Rate:</span>
                                <span class="stat-value">72%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Total Trades:</span>
                                <span class="stat-value">18</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <section class="log-controls">
                <h2>System Logs</h2>
                <div class="log-header">
                    <div class="log-filter">
                        <label for="log-level-selector">Filter by level:</label>
                        <select id="log-level-selector">
                            <option value="all">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="success">Success</option>
                        </select>
                    </div>
                    <div class="log-actions">
                        <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
                        <button class="btn btn-secondary" onclick="exportData('logs')">Export Logs</button>
                    </div>
                </div>
            </section>

            <section class="log-viewer">
                <div id="log-entries" class="log-container">
                    <!-- Populated by JavaScript -->
                </div>
            </section>
        </div>

        <!-- Backtest Tab -->
        <div id="backtest" class="tab-content">
            <section class="backtest-controls">
                <h2>Strategy Backtesting</h2>
                <div class="backtest-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="backtest-strategy">Strategy</label>
                            <select id="backtest-strategy">
                                <option value="momentum">Momentum</option>
                                <option value="meanReversion">Mean Reversion</option>
                                <option value="regimeDetection">Regime Detection</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="backtest-start">Start Date</label>
                            <input type="date" id="backtest-start">
                        </div>
                        <div class="form-group">
                            <label for="backtest-end">End Date</label>
                            <input type="date" id="backtest-end">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="runBacktest()">Run Backtest</button>
                </div>
            </section>

            <section class="backtest-results">
                <h2>Backtest Results</h2>
                <div class="chart-container">
                    <canvas id="backtest-chart"></canvas>
                </div>

                <div class="backtest-metrics">
                    <div class="metrics-row">
                        <div class="metric-item">
                            <div class="metric-label">Total Return</div>
                            <div class="metric-value" id="backtest-return">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value" id="backtest-sharpe">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Max Drawdown</div>
                            <div class="metric-value" id="backtest-drawdown">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Win Rate</div>
                            <div class="metric-value" id="backtest-winrate">--</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Notifications Container -->
    <div id="notifications-container" class="notifications-container">
        <!-- Notifications will be added here dynamically -->
    </div>

    <!-- Dashboard Filter Modal (NEW) -->
    <div id="filter-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Advanced Filters</h3>
                <button class="modal-close" onclick="closeFilterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filter-date-from">Date From</label>
                            <input type="date" id="filter-date-from">
                        </div>
                        <div class="form-group">
                            <label for="filter-date-to">Date To</label>
                            <input type="date" id="filter-date-to">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filter-strategy">Strategy</label>
                            <select id="filter-strategy">
                                <option value="">All Strategies</option>
                                <option value="SPY_Momentum">SPY Momentum</option>
                                <option value="QQQ_Momentum">QQQ Momentum</option>
                                <option value="SPY_RegimeDetection">SPY Regime</option>
                                <option value="QQQ_RegimeDetection">QQQ Regime</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-symbol">Symbol</label>
                            <select id="filter-symbol">
                                <option value="">All Symbols</option>
                                <option value="TQQQ">TQQQ</option>
                                <option value="SQQQ">SQQQ</option>
                                <option value="UPRO">UPRO</option>
                                <option value="SPXU">SPXU</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filter-log-level">Log Level</label>
                            <select id="filter-log-level">
                                <option value="">All Levels</option>
                                <option value="INFO">Info</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="SUCCESS">Success</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-limit">Result Limit</label>
                            <select id="filter-limit">
                                <option value="50">50 results</option>
                                <option value="100">100 results</option>
                                <option value="200">200 results</option>
                                <option value="500">500 results</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    
    <!-- NEW: Enhanced filter functionality -->
    <script>
        // Enhanced filter functions
        function openFilterModal() {
            document.getElementById('filter-modal').style.display = 'block';
        }

        function closeFilterModal() {
            document.getElementById('filter-modal').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-strategy').value = '';
            document.getElementById('filter-symbol').value = '';
            document.getElementById('filter-log-level').value = '';
            document.getElementById('filter-limit').value = '100';
        }

        async function applyFilters() {
            const filters = {
                dateFrom: document.getElementById('filter-date-from').value,
                dateTo: document.getElementById('filter-date-to').value,
                strategy: document.getElementById('filter-strategy').value,
                symbol: document.getElementById('filter-symbol').value,
                logLevel: document.getElementById('filter-log-level').value,
                limit: parseInt(document.getElementById('filter-limit').value)
            };

            // Remove empty filters
            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });

            const filteredData = await fetchFilteredData(filters);
            if (filteredData) {
                // Update app data with filtered results
                if (filteredData.trades) appData.recent_trades = filteredData.trades;
                if (filteredData.logs) appData.log_entries = filteredData.logs;
                if (filteredData.performance) appData.performance_metrics = filteredData.performance;
                
                // Refresh UI
                updateDashboard();
                showNotification('Filters applied successfully', 'success');
            }
            
            closeFilterModal();
        }

        // Enhanced backtest function
        async function runBacktest() {
            const strategy = document.getElementById('backtest-strategy').value;
            const startDate = document.getElementById('backtest-start').value;
            const endDate = document.getElementById('backtest-end').value;

            if (!startDate || !endDate) {
                showNotification('Please select start and end dates', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/backtest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        strategy,
                        start: startDate,
                        end: endDate
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                displayBacktestResults(result);
                showNotification('Backtest completed successfully', 'success');
            } catch (error) {
                showNotification('Backtest failed: ' + error.message, 'error');
            }
        }

        function displayBacktestResults(results) {
            if (results.performance) {
                document.getElementById('backtest-return').textContent = `${results.performance.totalReturn || 0}%`;
                document.getElementById('backtest-sharpe').textContent = results.performance.sharpeRatio || 0;
                document.getElementById('backtest-drawdown').textContent = `${results.performance.maxDrawdown || 0}%`;
                document.getElementById('backtest-winrate').textContent = `${results.performance.winRate || 0}%`;
            }
        }

        function clearLogs() {
            document.getElementById('log-entries').innerHTML = '';
            showNotification('Logs cleared', 'info');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('filter-modal');
            if (event.target == modal) {
                closeFilterModal();
            }
        }
    </script>
</body>
</html>